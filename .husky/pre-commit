#!/bin/sh

# 機密情報のパターンをチェック
echo "🔍 Checking for sensitive data patterns..."

# APIトークンやシークレットのパターンを検索（.huskyディレクトリを除外）
if git diff --cached --name-only | grep -v "^\.husky/" | xargs grep -E "(xoxp-[0-9a-zA-Z]{10,}|xoxb-[0-9a-zA-Z]{10,}|sk-[0-9a-zA-Z]{20,}|pk_[0-9a-zA-Z]{20,}|api_key.*=.*['\"][^'\"]{20,}|password.*=.*['\"][^'\"]+['\"])" 2>/dev/null; then
  echo "❌ Error: Potential secrets detected in staged files!"
  echo "Please remove sensitive data before committing."
  exit 1
fi

# 環境変数ファイルのチェック
if git diff --cached --name-only | grep -E "^\.env($|\.)" | grep -v -E "\.example$|\.sample$"; then
  echo "❌ Error: Attempting to commit .env file!"
  echo "Environment files should never be committed."
  exit 1
fi

# Biomeによるlintとformat
echo "🧹 Running Biome lint and format..."
npx biome check --write --no-errors-on-unmatched ./src

echo "✅ Pre-commit checks passed!"