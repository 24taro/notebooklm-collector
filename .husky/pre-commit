#!/bin/sh

# æ©Ÿå¯†æƒ…å ±ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯
echo "ğŸ” Checking for sensitive data patterns..."

# APIãƒˆãƒ¼ã‚¯ãƒ³ã‚„ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ¤œç´¢ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«åã®ã¿è¡¨ç¤ºï¼‰
SECRET_FILES=$(git diff --cached --name-only | grep -v "^\.husky/" | xargs grep -lE "(xoxp-[0-9a-zA-Z]{10,}|xoxb-[0-9a-zA-Z]{10,}|sk-[0-9a-zA-Z]{20,}|pk_[0-9a-zA-Z]{20,}|api_key.*=.*['\"][^'\"]{20,}|password.*=.*['\"][^'\"]+['\"])" 2>/dev/null || true)

if [ -n "$SECRET_FILES" ]; then
  echo "âŒ Error: Potential secrets detected in the following files:"
  echo "$SECRET_FILES"
  echo ""
  echo "Please remove sensitive data before committing."
  exit 1
fi

# ç’°å¢ƒå¤‰æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒã‚§ãƒƒã‚¯
ENV_FILES=$(git diff --cached --name-only | grep -E "^\.env($|\.)" | grep -v -E "\.example$|\.sample$" || true)

if [ -n "$ENV_FILES" ]; then
  echo "âŒ Error: Attempting to commit environment files:"
  echo "$ENV_FILES"
  echo ""
  echo "Environment files should never be committed."
  exit 1
fi

# lint-stagedã‚’å®Ÿè¡Œï¼ˆã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿å‡¦ç†ï¼‰
echo "ğŸ§¹ Running lint-staged..."
npx lint-staged

echo "âœ… Pre-commit checks passed!"